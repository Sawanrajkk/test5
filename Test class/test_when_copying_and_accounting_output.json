{
  "source_file": "test_when_copying_and_accounting_output.py",
  "lines": [
    "from dunetuf.configuration import Configuration\n",
    "\n",
    "from dunetuf.control.control import Control\n",
    "from dunetuf.scan.ScanAction import ScanAction\n",
    "from tests.copy.copy_base import TestGivenEmptyQueueAndEmptyHistory\n",
    "from tests.copy.copy_utils import create_and_start_copy_job\n",
    "class TestWhenCopyingAndAccountingOutput(\n",
    "    TestGivenEmptyQueueAndEmptyHistory\n",
    "):\n",
    "    @classmethod\n",
    "    def setup_class(cls):\n",
    "        \"\"\"Initialize shared test resources.\"\"\"\n",
    "        super().setup_class()\n",
    "        cls.configuration = Configuration(cls.cdm)\n",
    "        cls.scan_action = ScanAction()\n",
    "        cls.scan_action.set_tcl(cls.tcl).set_udw(cls.udw).set_configuration(cls.configuration)\n",
    "\n",
    "    @classmethod\n",
    "    def teardown_class(cls):\n",
    "        \"\"\"Clean up shared test resources.\"\"\"\n",
    "        super().teardown_class()\n",
    "\n",
    "    def teardown_method(self):\n",
    "        \"\"\"Clean up resources after each test.\"\"\"\n",
    "        # Clear job queue\n",
    "        self.job_queue.cancel_all_jobs()\n",
    "        self.job_queue.wait_for_queue_empty()\n",
    "\n",
    "        # Clear job history\n",
    "        self.job_history.clear()\n",
    "        self.job_history.wait_for_history_empty()\n",
    "\n",
    "        # Restore default ticket\n",
    "        response = self.update_default_ticket_if_required(self.default_ticket)\n",
    "        assert response == 200\n",
    "\n",
    "    \"\"\"\n",
    "    $$$$$_BEGIN_TEST_METADATA_DECLARATION_$$$$$\n",
    "        +purpose: Test with a simulated 100x100mm that copy accounting data is correct\n",
    "        +test_tier: 1\n",
    "        +is_manual: False\n",
    "        +reqid: DUNE-21713\n",
    "        +timeout: 200\n",
    "        +asset: LFP\n",
    "        +delivery_team: LFP\n",
    "        +feature_team: LFP_ScannerWorkflows\n",
    "        +test_framework: TUF\n",
    "        +external_files:\n",
    "        +test_classification:System\n",
    "        +name: TestWhenCopyingAndAccountingOutput::test_when_using_100x100_file_then_succeeds_and_scan_data_match\n",
    "        +test:\n",
    "            +title:TestWhenCopyingAndAccountingOutput::test_when_using_100x100_file_then_succeeds_and_scan_data_match\n",
    "            +guid:f1442d11-8515-41f4-b4cd-73e969202550\n",
    "            +dut:\n",
    "                +type: Simulator\n",
    "                +configuration:PrintEngineFormat=A4 & DeviceClass=MFP & DeviceFunction=Copy & EngineFirmwareFamily=Maia\n",
    "    $$$$$_END_TEST_METADATA_DECLARATION_$$$$$\n",
    "    \"\"\"\n",
    "\n",
    "    def test_when_using_100x100_file_then_succeeds_and_scan_data_match(\n",
    "        self\n",
    "    ):\n",
    "        # Create configuration Scan\n",
    "        height = 100  # mm\n",
    "        width = 100  # mm\n",
    "\n",
    "        # Init simulation\n",
    "        simulation = self.scan_action.set_scan_random_acquisition_mode(height, width)\n",
    "        Control.validate_simulation(simulation)\n",
    "\n",
    "        payload = self.copy.get_default_ticket()\n",
    "        job_id = create_and_start_copy_job(self.copy, payload)\n",
    "\n",
    "        # Wait for copy job to complete\n",
    "        self.copy.wait_for_state(job_id, [\"completed\"])\n",
    "\n",
    "        # Restore default scan simulation mode\n",
    "        simulation = self.scan_action.reset_simulation_mode()\n",
    "        Control.validate_simulation(simulation)\n",
    "\n",
    "        # Read Data and filter Job Telemetry\n",
    "        stats = self.job_history.get_stats()\n",
    "        job_scan_info_stats = stats[\"historyStats\"][-1][\"scanInfo\"]\n",
    "\n",
    "        # TO BE FIXED\n",
    "        # Currently, Jupiter simulator environment applies edge detection\n",
    "        # even if scan simulator strategy is set to random. Images coming\n",
    "        # from random strategy do not have the usual scanner gray background\n",
    "        # and edge detection has an unexpected input and clips the image.\n",
    "        new_width = 90\n",
    "        min_area = (height / 10) * (new_width / 10)\n",
    "        max_area = (height / 10) * (width / 10)\n",
    "\n",
    "        assert (\n",
    "            min_area\n",
    "            <= job_scan_info_stats[\"scanAreaUsage\"][\"scanArea\"][\"count\"]\n",
    "            <= max_area\n",
    "        )\n",
    "        assert job_scan_info_stats[\"scanAreaUsage\"][\"scanArea\"][\"unit\"] == \"sqcm\"\n",
    "        assert job_scan_info_stats[\"scanAreaUsage\"][\"scanLength\"][\"count\"] == height\n",
    "        assert (\n",
    "            job_scan_info_stats[\"scanAreaUsage\"][\"scanLength\"][\"unit\"] == \"millimeters\"\n",
    "        )\n"
  ]
}